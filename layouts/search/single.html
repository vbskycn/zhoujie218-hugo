{{ define "content"}}
{{- $datetime_format := i18n "Datetime_format" -}}
<div class="res-cons">
    <h3 class="archive-title">
        {{ i18n "Search" }}
        <span class="keyword"></span>
        {{ i18n "Search_results" }}
    </h3>

    <article class="post template" style="display:none"></article>
</div>

<script type="text/javascript">
    function getUrlParameter (sParam) {
        var query = window.location.search || window.location.href.split('?')[1] || '';
        var sPageURL = query.replace(/^\?/, '');
        var sURLVariables = sPageURL.split('&');
        var sParameterName,
            i;
        for (i = 0; i < sURLVariables.length; i++) {
            sParameterName = sURLVariables[i].split('=');
            if (sParameterName[0] === sParam) {
                return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
            }
        }
    }

    $(function () {
        var q = getUrlParameter("q");
        $("span.keyword").text(q);
        $("article.post").not('.template').remove();
        var $container = $("div.res-cons");
        $container.append($('<p class="loading">正在加载索引…</p>'));

        $.ajax({
            url: '{{ "index.json" | relURL }}?v={{ now.Unix }}',
            dataType: 'json',
            cache: false
        }).done(function(items){
            try {
                if (typeof items === 'string') {
                    items = JSON.parse(items);
                }
            } catch(e) {
                console.error('JSON parse error:', e);
                $container.find('p.loading').remove();
                $container.append($('<p class="error">索引解析失败</p>'));
                return;
            }
            var kw = (q || '').toLowerCase().trim();
            var hits = 0;
            if (!Array.isArray(items)) {
                console.warn('index.json unexpected shape', items);
                items = [];
            }
            items.forEach(function(it){
                var title = (it.title || '').toString();
                var desc = (it.description || it.summary || '').toString();
                var hit = (title.toLowerCase().indexOf(kw) >= 0) || (desc.toLowerCase().indexOf(kw) >= 0);
                if (hit) {
                    hits++;
                    var url = it.permalink;
                    var pubDate = it.date || '';
                    var post = $("<article class='post'></article>");
                    var header = $("<header><h1 class='post-title'></h1></header>");
                    header.find('h1').append($('<a></a>').attr('href', url).text(title));
                    post.append(header);
                    if (pubDate) post.append($("<time class='post-meta meta-date'></time>").text(pubDate));
                    post.append($("<div class='post-content'></div>").text((desc).substring(0, 180) + "……"));
                    post.append($("<p class='readmore'></p>").append($('<a></a>').attr('href', url).text({{ i18n "continueReading" }})));
                    $container.append(post);
                }
            });
            $container.find('p.loading').remove();
            if (hits === 0) {
                $container.append($('<p class="noresult">没有找到匹配内容</p>'));
            }
        }).fail(function(xhr){
            $container.find('p.loading').remove();
            $container.append($('<p class="error">无法加载索引文件 index.json（HTTP '+xhr.status+'）</p>'));
        });
    });
</script>
{{ end }} 