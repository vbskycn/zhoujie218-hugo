{{ define "content"}}
{{- $datetime_format := i18n "Datetime_format" -}}
<div class="res-cons">
    <h3 class="archive-title">
        {{ i18n "Search" }}
        <span class="keyword"></span>
        {{ i18n "Search_results" }}
    </h3>

    <article class="post template" style="display:none"></article>
</div>

<script type="text/javascript">
    function getUrlParameter (sParam) {
        var query = window.location.search || window.location.href.split('?')[1] || '';
        var sPageURL = (query.charAt(0) === '?') ? query.substring(1) : query;
        var sURLVariables = sPageURL.split('&');
        for (var i = 0; i < sURLVariables.length; i++) {
            var sParameter = sURLVariables[i].split('=');
            if (sParameter[0] === sParam) {
                return sParameter[1] === undefined ? '' : decodeURIComponent(sParameter[1].replace(/\+/g, ' '));
            }
        }
        return '';
    }

    document.addEventListener('DOMContentLoaded', function () {
        var q = getUrlParameter('q');
        var keywordEl = document.querySelector('span.keyword');
        if (keywordEl) keywordEl.textContent = q || '';

        var container = document.querySelector('div.res-cons');
        // loading hint
        var loading = document.createElement('p');
        loading.className = 'loading';
        loading.textContent = '正在加载索引…';
        container.appendChild(loading);

        function create(elem, cls, text) {
            var e = document.createElement(elem);
            if (cls) e.className = cls;
            if (text !== undefined) e.textContent = text;
            return e;
        }

        // fetch index.json with cache busting
        var url = '{{ "index.json" | relURL }}' + '?v=' + Date.now();
        fetch(url, { cache: 'no-store' })
            .then(function (resp) { return resp.json(); })
            .then(function (items) {
                container.removeChild(loading);
                if (!Array.isArray(items)) items = [];
                var kw = (q || '').toLowerCase().trim();
                var hits = 0;
                items.forEach(function (it) {
                    var title = (it.title || '').toString();
                    var desc = (it.description || it.summary || '').toString();
                    var ok = title.toLowerCase().indexOf(kw) >= 0 || desc.toLowerCase().indexOf(kw) >= 0;
                    if (ok) {
                        hits++;
                        var article = create('article', 'post');
                        var header = create('header');
                        var h1 = create('h1', 'post-title');
                        var a = create('a', null, title);
                        a.href = it.permalink;
                        h1.appendChild(a);
                        header.appendChild(h1);
                        article.appendChild(header);
                        if (it.date) {
                            var t = create('time', 'post-meta meta-date', it.date);
                            article.appendChild(t);
                        }
                        var content = create('div', 'post-content', (desc).substring(0, 180) + '……');
                        article.appendChild(content);
                        var more = create('p', 'readmore');
                        var moreA = create('a', null, '{{ i18n "continueReading" }}');
                        moreA.href = it.permalink;
                        more.appendChild(moreA);
                        article.appendChild(more);
                        container.appendChild(article);
                    }
                });
                if (hits === 0) {
                    container.appendChild(create('p', 'noresult', '没有找到匹配内容'));
                }
            })
            .catch(function (err) {
                container.removeChild(loading);
                container.appendChild(create('p', 'error', '无法加载索引文件 index.json'));
            });
    });
</script>
{{ end }} 